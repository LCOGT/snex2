{% extends 'tom_common/base.html' %}
{% load comments bootstrap4 tom_common_extras targets_extras observation_extras dataproduct_extras static cache %}
{% load custom_code_tags %}
{/* % load airmass_tags % */}
{% block title %}Target {{ object.name }}{% endblock %}
{% block additional_css %}
<link rel="stylesheet" href="{% static 'tom_targets/css/targets_snexclone.css' %}">
{% endblock %}
{% block content %}
<style>
.dropdown-content {
  display: none;
  position: absolute;
}

.show {display: block;}
</style>
<table class="header-table" cellpadding="0" cellspacing="0" style="background: #174460; font-family: 'Open Sans', sans-serif; color: white; width: 104.45%; margin-left: -39px; margin-top: -100px;">
  <tr height="89">
    <td align="left">
      <span style="display: inline-block; font-size: 30px; margin-left: 30px;">{{ target.name }}</span>
    </td>
    <td align="left">
      <span style="display: inline-block; font-size: 20px;">{{ target|target_extra_field:"classification" }}</span>
    </td>
    <td align="left">
      <form style="display: inline; font-size: 20px" name="form_redshift_theredshift" autocomplete="off" action="javascript: edit_redshift()">
        <span id="zpre">z=</span>
        <input type="hidden" name="targetid" id="thetargetid" value={{ target.id }}>
        <input type="text" name="redshift" id="thenewredshift" value={{ target|target_extra_field:"redshift" }} autocomplete="off" style="background: none; border: 0px solid #174460; font-family: 'Open Sans', sans-serif; font-size: 16; color: white;">
      </form>
    </td>
    <script>
    /* When the user clicks on the button,
    toggle between hiding and showing the dropdown content */
    // function myFunction() {
    //   document.getElementById("myDropdown").classList.toggle("show");
    // }
    // 
    // // Close the dropdown if the user clicks outside of it
    // window.onclick = function(event) {
    //   if (!event.target.matches('.dropbtn')) {
    //     var dropdowns = document.getElementsByClassName("dropdown-content");
    //     var i;
    //     for (i = 0; i < dropdowns.length; i++) {
    //       var openDropdown = dropdowns[i];
    //       if (openDropdown.classList.contains('show')) {
    //         openDropdown.classList.remove('show');
    //       }
    //     }
    //   }
    // }
    function edit_redshift() {
      var targetid = {{ target.id }};
      var redshiftid = {{ target|get_redshift_id }};
      var new_value = $('#thenewredshift').val();
      var newdata = {
        "key": "redshift",
        "value": new_value
      };
      if (redshiftid != null) {
	newdata = {
	  "id": redshiftid,
	  "key": "redshift",
	  "value": new_value
	};
      }
      console.log(targetid, redshiftid, new_value);
      $.ajax({
	url: '/api/targets/' + targetid + '/',
	type: "PATCH",
	headers: {"X-CSRFToken": '{{ csrf_token }}'}, 
	data: JSON.stringify({
	  "targetextra_set": [
	    newdata
	  ]
	}),
	contentType: "application/json",
	dataType: "json",
	error: function(e) {
	  console.log(e);
	}
      })
    }
    </script>
    <td align="left">
      <span style="display: inline-block; font-size: 20px;">{{ target.ra|deg_to_sexigesimal:"hms" }} {{ target.dec|deg_to_sexigesimal:"dms" }}<br>{{ target.ra|floatformat:4 }} {{ target.dec|floatformat:4 }}</span>
    </td>
  </tr>
</table>
<!--nav class="navbar navbar-expand-md fixed-top fixed-top-2">
  <div class="collapse navbar-collapse" id="targetInfo">
      <ul class="nav mr-auto">
        <li style="float: left;"><a style="display: inline-block; list-style-type: none;">{{ target.name }}</a></li>
        <li style="float: left;"><a style="display: inline-block; list-style-type: none;">{{ target.ra|deg_to_sexigesimal:"hms" }} {{ target.dec|deg_to_sexigesimal:"dms" }}<br>{{ target.ra|floatformat:4 }} {{ target.dec|floatformat:4 }}</a></li>
	<li style="float: left;"><a style="display: inline-block; list-style-type: none;">{{ target|target_extra_field:"classification" }}</a></li>
        <li style="float: left;"><a style="display: inline-block; list-style-type: none;">z = {{ target|target_extra_field:"redshift" }}</a></li>
      </ul>
  </div-->
</nav>
<ul class="nav nav-tabs" id="tabs">
  <li class="nav-item">
    <span class="nav-link active" data-target="#observe" data-toggle="tab">Overview</span>
  </li>
  <li class="nav-item">
    <span class="nav-link" data-target="#observations" data-toggle="tab">Observations</span>
  </li>
  <li class="nav-item">
    <span class="nav-link" data-target="#manage-data" data-toggle="tab">Manage Data</span>
  </li>
  <li class="nav-item">
    <span class="nav-link" data-target="#manage-groups" data-toggle="tab">Manage Groups</span>
  </li>
  <li class="nav-item">
    <span class="nav-link" data-target="#photometry" data-toggle="tab">Photometry</span>
  </li>
  <li class="nav-item">
    <span class="nav-link" data-target="#spectroscopy" data-toggle="tab">Spectroscopy</span>
  </li>
</ul>
<div class="row">
  <div class="col-md-2" id="target-info">
    {% target_data object %}
  </div>
  <div class="col-md-12">
    <div class="tab-content">
      <div class="tab-pane in active" id="observe">
        <div class="row">
        <div class="col-md-6">
          {% comments_enabled as comments_are_enabled %}
          <h4>Latest Comments</h4>
            {% if comments_are_enabled %}
              {% render_comment_list for object %}
              {% url 'targets:detail' object.id as next %}
              {% if user.is_authenticated %}
                {% render_comment_form for object %}
              {% endif %}
            {% endif %}
        </div>
        <div class="col-md-6">
          <h4>Latest Visibility at LCO</h4>
          {% airmass_plot %}
        </div>
        </div>
        <hr/>
	<div class="row">
        <div class="col-md-6">
          {% aladin object %}
        </div>
	<!--div class="col-md-6">
	  <div class="dropdown" style="position: relative;display: inline-block;">
	    <button onclick="myFunction()" class="dropbtn">{{ target|target_extra_field:"classification" }}</button>
	    <div id="myDropdown" class="dropdown-content">
	      <p>SN Ia</p>
	      <p>SN II</p>
	    </div>
	  </div>
	</div-->
	</div>
        <hr/>
        <div class="row">
        <div class="col-md-6">
          <h4>Photometry</h4>
          {% lightcurve object %}
        </div>
        <div class="col-md-6">
          <h4>Spectroscopy</h4>
          {% spectra_plot object %}
        </div>
        </div>
      </div>
      <div class="tab-pane" id="observations">
        <h4>Schedule Observations</h4>
        {% observing_buttons object %}
        <hr/>
        <h4>Previous Observations</h4>
        <a href="{% url 'targets:detail' pk=target.id %}?update_status=True" title="Update status of observations for target" class="btn btn-primary">Update Observations Status</a>
        {% observation_list object %}
      </div>
      <div class="tab-pane" id="manage-data">
	{% if user.is_authenticated %}
	  {% upload_dataproduct object %}
	{% endif %}
        {% dataproduct_list_for_target object %}
      </div>
      <div class="tab-pane" id="manage-groups">
        {% target_groups target %}
      </div>
      <div class="tab-pane" id="photometry">
	{% photometry_for_target target %}
      </div>
      <div class="tab-pane" id="spectroscopy">
        {% spectroscopy_for_target target %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

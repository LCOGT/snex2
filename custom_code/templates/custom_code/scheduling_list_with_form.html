{% load bootstrap4 targets_extras custom_code_tags %}
<style>
#id_cadence_frequency {
    width: 50px;
}
#id_ipp_value {
    width: 50px;
}
#id_max_airmass {
    width: 50px;
}
#id_reminder {
    width: 50px;
}
.exposure-row {
    width: 350px;
}
</style>
<table class="table">
  <thead>
    <tr>
      <th>View</th>
      <th>Target</th>
      <th>Facility</th>
      <th>Observation Type</th>
      <th>Instrument</th>
      <th>Cadence</th>
      <th>IPP</th>
      <th>Max Airmass</th>
      <th>Exposures</th>
      <th>Reminder in</th>
      <th>Start</th>
      <th>Reminder</th>
      <th>Classification</th>
      <th>Redshift</th>
    </tr>
  </thead>
  <tbody>
    {% for parameter in parameters %}
    <tr>
      <td><a class="btn btn-success" href="{% url 'tom_observations:detail' parameter.observation_id %}">Details</a></td>
      <td><a href="{% url 'tom_targets:detail' parameter.target.id %}" title="{{ parameter.target.id }}">{{ parameter.target.names|join:", " }}</a></td>
      <td>{{ parameter.facility }}</td>
      <td>{{ parameter.observation_type }}</td>
      <td>{{ parameter.instrument }}</td>
      {% if parameter.observation_type == "Phot" %}
      <form method="post" class="form" id="scheduling-form-{{ parameter.observation_id }}">
	{% bootstrap_form form exclude='cadence_frequency,ipp_value,max_airmass,U,B,V,R,I,u,gp,rp,ip,zs,w,reminder' %}
	<td>{{ form.cadence_frequency }}</td>
	<td>{{ form.ipp_value }}</td>
	<td>{{ form.max_airmass }}</td>
	<td>
	  <div class="exposure-row">Exposure Time Exposures Block No.</div>
	  <div class="exposure-row">{{ form.U.label }}{{ form.U }}</div>
	  <div class="exposure-row">{{ form.B.label }}{{ form.B }}</div>
	  <div class="exposure-row">{{ form.V.label }}{{ form.V }}</div>
	  <div class="exposure-row">{{ form.R.label }}{{ form.R }}</div>
	  <div class="exposure-row">{{ form.I.label }}{{ form.I }}</div>
	  <div class="exposure-row">{{ form.u.label }}{{ form.u }}</div>
	  <div class="exposure-row">{{ form.gp.label }}{{ form.gp }}</div>
	  <div class="exposure-row">{{ form.rp.label }}{{ form.rp }}</div>
	  <div class="exposure-row">{{ form.ip.label }}{{ form.ip }}</div>
	  <div class="exposure-row">{{ form.zs.label }}{{ form.zs }}</div>
	  <div class="exposure-row">{{ form.w.label }}{{ form.w }}</div>
	</td>
	<td>
	  <div class="row">{{ form.reminder }} days</div>
	  <div class="row">
	  {% csrf_token %}
	  {% buttons %}
	  <input onclick="modify_sequence(this.id)" class="btn btn-primary" value="Modify Sequence" id="modify-{{ parameter.observation_id }}" readonly>
	  <input onclick="modify_sequence(this.id)" class="btn" style="background-color: green; color: white;" value="Continue As-is" id="continue-{{ parameter.observation_id }}" readonly>
	  <input onclick="modify_sequence(this.id)" class="btn" style="background-color: red; color: white;" value="Stop Sequence" id="stop-{{ parameter.observation_id }}" readonly>
          {% endbuttons %}
	  </div>
	</td>
      </form>
      {% else %}
      <form method="post" class="form" id="scheduling-form-{{ parameter.observation_id }}">
	{% bootstrap_form form exclude='cadence_frequency,ipp_value,max_airmass,exposure_time,reminder' %}
	<td>{{ form.cadence_frequency }}</td>
	<td>{{ form.ipp_value }}</td>
	<td>{{ form.max_airmass }}</td>
	<td>
	  <div class="exposure-row">Exposure Time</div>
	  <div class="exposure-row">{{ form.exposure_time }}</div>
	</td>
	<td>
	  <div class="row">{{ form.reminder }} days</div>
	  <div class="row">
	  {% csrf_token %}
	  {% buttons %}
	  <input onclick="modify_sequence(this.id)" class="btn btn-primary" value="Modify Sequence" id="modify-{{ parameter.observation_id }}" readonly>
	  <input onclick="modify_sequence(this.id)" class="btn" style="background-color: green; color: white;" value="Continue As-is" id="continue-{{ parameter.observation_id }}" readonly>
	  <input onclick="modify_sequence(this.id)" class="btn" style="background-color: red; color: white;" value="Stop Sequence" id="stop-{{ parameter.observation_id }}" readonly>
          {% endbuttons %}
	  </div>
	</td>
      </form>
      {% endif %}
      <td>{{ parameter.start }}</td>
      <td>{{ parameter.reminder }}</td>
      <td>
      {% with parameter.target as target %}
        {% if target|target_extra_field:"classification" %}
          {{ target|target_extra_field:"classification" }}
        {% else %}
          None
        {% endif %}
      </td>
      <td>
	{% if target|target_extra_field:"redshift" %}
	  {% with z=target|target_extra_field:"redshift" %}
	  {{ z|strip_trailing_zeros }}
	  {% endwith %}
	{% else %}
	  None
	{% endif %}
      {% endwith %}
      </td>
    </tr>
      <td colspan=10 style="border-top:none;">
        <div class="collapse show" id="show-both-{{parameter.target.name|cut:" "}}">
          <div id="lightcurve-{{parameter.observation_id}}" class="lightcurve-{{parameter.target.name|cut:" "}}" style="display: inline-block; text-align: center"></div>
          <div id="spectra-{{parameter.observation_id}}" class="spectra-{{parameter.target.name|cut:" "}}" style="display: inline-block; text-align: center"></div>
          <div id="airmass-{{parameter.observation_id}}" class="airmass-{{parameter.target.name|cut:" "}}" style="display: inline-block; text-align: center"></div>
        </div>
      </td>
    </tr>
    <script>
      $(document).ready(function() {
        $.ajax({
          url: '{% url "targetlist_collapse" %}',
          data: {'target_id': {{ parameter.target.id }},
                 'user_id': {{ parameter.user_id }}},
          dataType: 'json',
          success: function(response) {
            var lightcurve_plot = response.lightcurve_plot;
            $('#lightcurve-{{parameter.observation_id}}').html(lightcurve_plot);
            var spectra_plot = response.spectra_plot;
            $('#spectra-{{parameter.observation_id}}').html(spectra_plot);
            var airmass_plot = response.airmass_plot;
            $('#airmass-{{parameter.observation_id}}').html(airmass_plot);
          }
        });
      });
    </script>
    {% empty %}
    <tr>
      <td colspan="7">
        No observations yet. You might want to create an observation from one of
        <a href="{% url 'tom_targets:list' %}">your saved targets</a>.
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script>
function modify_sequence(clickedId) {
  var thenum = clickedId.replace( /^\D+/g, '');
  var theformstr = '#scheduling-form-' + thenum;
  //var theformdata = $(theformstr).serializeArray().reduce(function(obj, item) {
  //  obj[item.name] = item.value;
  //  return obj;
  //});
  $.ajax({
    url: '{% url "custom_code:scheduling" %}',
    data: $(theformstr).serialize() + "&button=" + clickedId,
    dataType: 'json',
    success: function(response) {
      if (response.success === 'Modified') {
        $.ajax({
          url: '{% url "api:observations-list" %}',
          type: "POST",
          headers: {"X-CSRFToken": '{{ csrf_token }}'}, 
          data: response.data,
          contentType: "application/json",
          dataType: "json"
        });
      };
      document.getElementById(clickedId).value = response.success;
    }
  });
}

$("#id_cadence_frequency").keyup(function() {
  var t = this;
  var table = t.closest(".table");
  var newreminder = 2*parseFloat(t.value) + 0.7;
  var reminder = table.querySelectorAll('input[name="reminder"]')[0];
  reminder.value = newreminder;
});
</script>
